<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Survey Bot Demo</title>
    <style>
        /* Reset styles to prevent conflicts with parent page */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body { 
            margin: 0; 
            padding: 0; 
            background-color: #ffffff; 
            font-family: sans-serif;
            height: 100vh;
            overflow: hidden;
        }
        
        .chat-container { 
            margin: 0; 
            width: 100%; 
            height: 100vh; 
            border: none; 
            display: flex; 
            flex-direction: column; 
        }
        
        .chat-header { background-color: #444; color: white; padding: 10px; flex-shrink: 0;}
        .chat-log { background-color: #f8f9fa; padding: 10px; flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 8px;} /* Added gap */
        .input-container { background: #f0f2f5; border-top: 1px solid #ccc; padding: 8px 12px; display: flex; flex-shrink: 0;}
        .chat-input { flex-grow: 1; margin-right: 10px; padding: 8px; border: 1px solid #ccc; border-radius: 4px;}
        .send-button { padding: 8px 15px; cursor: pointer;}
        /* Simple message styling */
        .message { padding: 8px 12px; border-radius: 15px; max-width: 80%; word-wrap: break-word; line-height: 1.4;}
        .user-message { background-color: #dcf8c6; align-self: flex-end; margin-left: auto; border-radius: 15px 15px 4px 15px;}
        .bot-message { background-color: #eee; align-self: flex-start; border-radius: 4px 15px 15px 15px;}
         /* Hide internal scrollbar on main input */
         #chatInput { scrollbar-width: none; -ms-overflow-style: none; }
         #chatInput::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            Survey Bot Demo
        </div>
        <div id="chatLog" class="chat-log">
            {% for msg_item in history %}
                {% if msg_item.role == 'user' %}
                    <div class="message user-message">{{ msg_item.parts[0] }}</div>
                {% elif msg_item.role == 'model' %}
                    <div class="message bot-message">{{ msg_item.parts[0] }}</div>
                {% endif %}
            {% endfor %}
        </div>

        <form id="chatForm" method="post" action="/">
            <div class="input-container">
                <input type="hidden" name="session_id" value="{{ session_id }}">
                <textarea
                    id="chatInput"
                    name="prompt"
                    class="chat-input"
                    placeholder="Type something..."
                    rows="1"
                    aria-label="Chat message input"
                    required
                ></textarea>
                <button class="send-button" type="submit" aria-label="Send message">
                    Send
                </button>
            </div>
        </form>
    </div>

    <script>
        const chatLog = document.getElementById("chatLog");
        const chatInput = document.getElementById("chatInput");
        const chatForm = document.getElementById('chatForm');
        const sendButton = chatForm?.querySelector('button');

        if (chatLog) {
            chatLog.scrollTop = chatLog.scrollHeight;
        }

        function autoResizeTextarea(element) {
            if (!element) return;
            element.style.height = 'auto';
            const newHeight = Math.min(150, Math.max(38, element.scrollHeight));
            element.style.height = newHeight + 'px';
        }

        if (chatInput) {
            chatInput.focus();
            chatInput.addEventListener('input', () => autoResizeTextarea(chatInput));
            autoResizeTextarea(chatInput);

             chatInput.addEventListener('keydown', (event) => {
                 if (event.key === "Enter" && !event.shiftKey) {
                     event.preventDefault();
                     if (chatForm && sendButton && !sendButton.disabled && chatInput.value.trim() !== "") {
                         chatForm.submit();
                     }
                 }
             });
        }

        // Function to send data to Qualtrics
        function sendDataToQualtrics(dataObject) { // Renamed parameter for clarity
            const jsonString = JSON.stringify(dataObject);
            console.log("[IFRAME] Attempting to send data to Qualtrics. Object:", dataObject);
            console.log("[IFRAME] JSON String being sent:", jsonString); // Log the actual string

            if (window.parent && window.parent.postMessage) {
                window.parent.postMessage({
                    type: 'chatbot_data',
                    data: jsonString // Send the stringified data
                }, '*'); // In production, replace '*' with your Qualtrics instance origin
                console.log("[IFRAME] postMessage sent.");
            } else {
                console.error("[IFRAME] Cannot access window.parent.postMessage. Is it in an iframe?");
            }
        }

        // --- Single listener for messages from parent (Qualtrics) ---
        window.addEventListener('message', function(event) {
            // console.log("[IFRAME] Message received from parent:", event.data); // Basic log

            // It's good practice to check the origin in production
            // const expectedOrigin = "https://yourqualtricsinstance.qualtrics.com";
            // if (event.origin !== expectedOrigin) {
            //     console.warn(`[IFRAME] Message from unexpected origin: ${event.origin}. Expected: ${expectedOrigin}`);
            //     return;
            // }

            if (event.data && event.data.type) {
                console.log(`[IFRAME] Message type: ${event.data.type} received from parent. Full data:`, event.data);
                switch (event.data.type) {
                    case 'get_chat_data':
                        const currentMessages = Array.from(chatLog.querySelectorAll('.message')).map(msg => ({
                            role: msg.classList.contains('user-message') ? 'user' : 'model',
                            text: msg.textContent.trim()
                        }));
                        sendDataToQualtrics({
                            session_id: document.querySelector('input[name="session_id"]').value,
                            history: currentMessages
                        });
                        break;
                    case 'init_chatbot':
                        chatbotConfig = event.data.config;
                        console.log("[IFRAME] Chatbot configured:", chatbotConfig);
                        if (chatbotConfig && chatbotConfig.uiConfig) {
                            if (document.querySelector('.chat-header')) {
                                document.querySelector('.chat-header').textContent = chatbotConfig.uiConfig.headerText || "Survey Bot Demo";
                            }
                            if (document.querySelector('#chatInput')) {
                                document.querySelector('#chatInput').placeholder = chatbotConfig.uiConfig.inputPlaceholder || "Type something...";
                            }
                        }
                        // Send config to your Python backend if needed (ensure /config endpoint exists)
                        fetch('/config', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(chatbotConfig)
                        })
                        .then(response => console.log("[IFRAME] Config sent to server, status:", response.status))
                        .catch(error => console.error("[IFRAME] Error sending config to server:", error));
                        break;
                    default:
                        console.log("[IFRAME] Received unhandled message type from parent:", event.data.type);
                }
            } else {
                console.warn("[IFRAME] Received message from parent without data.type property:", event);
            }
        });
        
        // Modified form submission handler
        if (chatForm) {
            chatForm.addEventListener('submit', (event) => {
                // For a traditional form submission that reloads the page,
                // event.preventDefault() is not strictly needed here unless you want to stop it for AJAX.
                // However, the data sending should ideally happen *after* the server responds and updates history.
                // The current approach sends data *before* the server processes the new prompt.

                if (chatInput && chatInput.value.trim() === "") {
                    event.preventDefault(); // Prevent empty submission
                    alert("Please enter a message.");
                    chatInput.focus();
                    return; // Stop further processing for empty input
                }
                
                console.log("[IFRAME] Form submitted. Gathering data to send to Qualtrics.");
                // This captures the state of the DOM *before* the current input is processed by the backend and added to history by Jinja.
                const chatMessagesForSubmit = Array.from(chatLog.querySelectorAll('.message')).map(msg => ({
                    role: msg.classList.contains('user-message') ? 'user' : 'model',
                    text: msg.textContent.trim()
                }));

                // To include the *current* user's input before it's officially in the history from the server:
                // const currentUserPrompt = chatInput.value.trim();
                // if (currentUserPrompt) {
                //    chatMessagesForSubmit.push({ role: 'user', text: currentUserPrompt });
                // }
                // Be cautious with this, as the page will reload and Jinja will render the history from the server,
                // potentially leading to duplication if not handled carefully.

                sendDataToQualtrics({
                    session_id: document.querySelector('input[name="session_id"]').value,
                    history: chatMessagesForSubmit
                });

                // The form will now submit to your Python backend as normal.
            });
        }
    </script>
</body>
</html>